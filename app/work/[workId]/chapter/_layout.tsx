import {
	Link,
	Slot,
	router,
	useLocalSearchParams,
	useNavigation,
} from "expo-router"
import { createContext, useContext, useEffect, useState } from "react"
import { Text, View } from "react-native"
import useLoading from "../../../../hooks/useLoading"
import { workScraperNew } from "../../../../services/ao3/scraper/work"
import getReadthrough from "../../../../services/saver/database/getReadthrough"
import getWork from "../../../../services/saver/database/getWork"
import updateReadthrough from "../../../../services/saver/database/updateReadthrough"
import updateWork from "../../../../services/saver/database/updateWork"
import IconBtn from "../../../../components/common/IconBtn"
import useStyle from "../../../../hooks/useStyle"
import Header from "../../../../components/common/Header"
import { AO3Work } from "../../../../services/ao3/types/work"
import Loaded from "../../../../components/common/Loaded"
import { useWorkContext } from "../_layout"

export default function ChapterReaderLayout() {
	const work = useWorkContext()

	const style = useStyle({
		titleColumn: {
			display: "flex",
			flexDirection: "column",
			// width: "80%",
			flexShrink: 1,
		},
		titleText: {
			color: "white",
		},
		chapterText: {
			color: "white",
		},
	})

	return (
		<>
			<Header>
				<View style={style.titleColumn}>
					{/* work title */}
					<Loaded
						isLoading={work.currentMeta().status}
						loading={<Text></Text>}
					>
						<Text
							style={style.titleText}
							ellipsizeMode="tail"
							numberOfLines={1}
						>
							{work.currentMeta().data?.title}
						</Text>
					</Loaded>
					{/* chapter name */}
					<Loaded
						isLoading={work.currentChapterFromList().status}
						loading={<Text></Text>}
					>
						<Link
							href={"../chapterSelect"}
							style={style.titleText}
							ellipsizeMode="tail"
							numberOfLines={1}
							disabled={(() => {
								const maxChapters =
									work.currentMeta().data?.stats.maxChapters

								return maxChapters && maxChapters == 1
									? true
									: false
							})()}
						>
							{(() => {
								const chapter =
									work.currentChapterFromList().data
								const maxChapters =
									work.currentMeta().data?.stats.maxChapters

								const title =
									chapter?.title ??
									work.work.data?.chapters[0].title

								if (
									title &&
									(maxChapters === null ||
										(maxChapters && maxChapters > 1))
								) {
									return `Chapter ${
										work.currentChapter + 1
									}: ${title}`
								}

								if (
									maxChapters === null ||
									(maxChapters && maxChapters > 1)
								) {
									return `Chapter ${work.currentChapter + 1}`
								}

								if (chapter?.title) return `${title}`
							})()}
						</Link>
					</Loaded>
				</View>
				{/* save work btn */}
				<View>
					<Loaded isLoading={work.currentMeta().status}>
						<IconBtn
							name={
								work.isSaved ? "bookmark" : "bookmark-outline"
							}
							size={32}
							iconStyle={{ color: "white" }}
							onPress={() => {
								work.setSaved(!work.isSaved)
								// if (workDb.data)
								// 	updateWork({
								// 		workId: workDb.data.workId,
								// 		availableChapters:
								// 			workDb.data.availableChapters,
								// 		isOffline: workDb.data.isOffline,
								// 		isSaved: !workDb.data.isSaved,
								// 		lastUpdate: workDb.data.lastUpdate,
								// 		totalChapters:
								// 			workDb.data.totalChapters,
								// 	}).then(() => workDb.reload())
							}}
						/>
					</Loaded>
				</View>
			</Header>
			<Slot />
		</>
	)
}
